### 그래픽스 파이프라인 - 래스터화(Rasterization) 중

# 클리핑(Clipping)

### 절두체 컬링(Frustum Culling) 수행
- 카메라 영역을 이용한 절두체(Camere Frustum) 컬링을 수행하여, 카메라 영역에 포함되어 있는 물체들을 클립 공간으로 이동한다.
- 카메라 영역에 포함되어 있지 않은 물체들은 생략함으로써 랜더링을 수행할 물체의 개수를 줄여 작업 효율을 높인다.

<img src="https://github.com/hdh5184/Problem-Solving-Ability-Application/assets/127714162/832072be-fb4d-4078-8454-9c516f7fbf37" width="50%" title="px(픽셀) 크기 설정" alt="RubberDuck"></img>
> 사진 참고 : https://docs.unrealengine.com/4.26/en-US/RenderingAndGraphics/VisibilityCulling/

### 투영 변환(perspective transformation)
- 카메라 영역 내 모든 물체들은 투영 변환을 통해 직육면체로 이룬 3차원 클립 공간으로 이동된다.
- 최종적으로 3차원 공간을 2차원 평면으로 확인할 원근법을 적용하기 위해 카메라 절두체 영역을 직육면체 클립 공간으로 변환한다.
- 클립 공간 내 물체들은 투영 변환을 거치면서 원근법이 적용된 물체로 변형된다. (카메라 위치로부터 먼 물체일수록 상대적으로 크기가 작아짐)
- 투영 변환을 통해 카메라 공간의 오른손 좌표계가 클립 공간의 왼손 좌표계로 변환된다. (면을 이루는 정점 순서는 변경되지 않는다.)

#### 원근 나눗셈(Perspective division)
- 카메라 공간의 절두체 영역을 직육면체로 이룬 3차원 클립 공간으로 변환하는 데 수행된다.
- 투영 변환된 클립 공간의 모든 3차원 성분을 z 값으로 나눈다. (-z 곱하기)
  - 실질적으로 z값은 투영 변환된 정점의 동차좌표 (x,y,z,w)에서 w성분에 저장되어 있기에 w성분 값으로 모든 성분을 나눈다.
 <img src="https://github.com/hdh5184/Problem-Solving-Ability-Application/assets/127714162/fec2c836-c86c-4025-b02f-d3bbfdd567c1" width="50%" title="px(픽셀) 크기 설정" alt="RubberDuck"></img>

- 원근 나눗셈으로 동차 좌표계 (x,y,z,w)에서 (x,y,z)의 3차원 클립 공간으로 변환된다.
- 각 3차원 좌표 범위가 [-1, 1]로 이루기에 NDC(normalized device coordinates)공간으로 정규화한다. (DirectX의 경우 z 좌표 범위가 [0,1]이다)
- 클립 공간 내 물체들이 NDC 공간 내에 위치하게 된다.

<img src="https://github.com/hdh5184/Problem-Solving-Ability-Application/assets/127714162/4db9a473-3116-439f-b143-63bbe135293c" width="50%" title="px(픽셀) 크기 설정" alt="RubberDuck"></img>
 > 사진 참고 : https://stackoverflow.com/questions/46164180/calculating-frustum-fov-for-a-perspectivecamera

### 클리핑(Clipping)

- 투영 변환이 이루어진 클립 공간 내 물체들 중 클립 공간 영역의 일부만이 포함되어 있는 물체에 적용된다.
- 해당 물체 영역을 클립 공간 내부와 외부로 분리하여 별개의 물체로 나눈다 (잘린 부분을 기점으로 새로운 정점이 생성된다).
- 클립 공간 외부로 분리된 물체를 랜더링할 물체에서 생략한다. 
- 절두체 영역에서 클리핑을 수행하는 것보다 투영 변환 - 정규화된 NDC 영역에서 수행하는 것이 더 효율적이다.

<img src="https://github.com/hdh5184/Problem-Solving-Ability-Application/assets/127714162/af5be8bf-2eb5-40f4-9124-40a5c8a840ba" width="50%" title="px(픽셀) 크기 설정" alt="RubberDuck"></img>
 > 절두체 영역에서 클리핑 수행

<img src="https://github.com/hdh5184/Problem-Solving-Ability-Application/assets/127714162/70504393-fd23-476e-8c3e-52bd9dccce9a" width="50%" title="px(픽셀) 크기 설정" alt="RubberDuck"></img>
 > NDC 영역에서 클리핑 수행   
사진 참고 : https://gfxcourses.stanford.edu/cs248/winter21/lecture/texture/

   
# 뒷면 제거(Back-face culling)

### 벡터의 내적을 이용하는 방법
- 면을 이루는 법선 벡터와, 면을 이루는 정점부터 카메라를 바라보는 벡터를 이용한다. (z축 방향)
- 두 벡터의 내적을 계산한 결과를 통해 면의 앞뒤 방향(또한 변만 보이는 옆)을 판별할 수 있다.
<img width="70%" alt="image" src="https://github.com/hdh5184/Problem-Solving-Ability-Application/assets/127714162/33609784-b0a9-4f48-bcf6-016702416a55">

- 카메라 절두체 영역과 투영 변환 영역(NDC 영역)은 z축이 서로 상반되기에 각각의 앞뒤 방향 판별도 상반된다.
- NDC 영역은 기존 카메라를 바라보는 벡터 방향이 -z축 방향이며, 단일 벡터만으로 투영한다.
<img width="70%" alt="image" src="https://github.com/hdh5184/Problem-Solving-Ability-Application/assets/127714162/bb597909-1863-447a-84ea-dc52a1c482c0">

### 삼각형의 정점 정렬 순서를 이용하는 방법 (행렬식)
- NDC 영역 내 2차원으로 투영된 삼각형 면의 정점 정렬 순서를 이용한다.
- 삼각형 면을 이루는 정점 좌표로 행렬식을 이용한 결과에 따라 면의 앞뒤 방향을 판별할 수 있다.
- 백터의 내적을 이용하는 방법보다 간편하다.
<img width="50%" alt="행렬식" src="https://github.com/hdh5184/Problem-Solving-Ability-Application/assets/127714162/60c870e7-23d7-4072-aa0d-a3b4a91d03e5">

- 행렬식의 값이 양수일 경우 앞면으로, 음수일 경우 뒷면으로 판별한다.
- 행렬식 값은 정점 정렬이 시계 방향인 경우 음수, 반시계 방향인 경우 양수로 계산되므로 정점 정렬이 시계 방향인 경우가 뒷면을 이룬다.
<img width="70%" alt="image-2" src="https://github.com/hdh5184/Problem-Solving-Ability-Application/assets/127714162/476863fa-1f63-473f-8562-cdef969dbb38">

> 위의 방법들을 통해 뒷면을 추려낸다.   
> 불투명한 물체의 뒷면이 화면상에 보이지 않기에 렌더링 대상에서 제외하기 위해 사용되나, (반)투명한 물체의 경우 뒷면이 화면상에 보이거나 뒤의 물체와 색상 보간을 위해 생략하기도 한다.



#### 참고 자료
> https://woo-dev.tistory.com/172    
> https://jidon333.github.io/blog/Rendering-pipeline    
> http://15462.courses.cs.cmu.edu/fall2021/home    
> https://j1y00h4.tistory.com/10    
